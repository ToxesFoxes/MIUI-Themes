<?xml version="1.0" encoding="utf-8"?>
<Lockscreen frameRate="60" frameRateBatteryLow="30" frameRateCharging="60" screenWidth="1080" version="1">
  <!-- Глобальные переменные -->

  <!-- Определение ширины и высоты экрана -->
  <Var expression="#screen_width" name="sw" type="number"/>
  <Var expression="#screen_height" name="sh" type="number"/>
  <Var expression="max(min(#S_moveX+int(#SLS_moveAn),1080),-1080)" name="dSx"/>
  <Var expression="max(min(#S_moveY+int(#SLS_moveAn),1080),-1080)" name="dSy"/>

  <!-- Инициализаторы -->
  <ExternalCommands>
    <Trigger action="resume">
    </Trigger>
    <Trigger action="init">
      <VariableCommand expression="0" name="current_app"/>
    </Trigger>
    <Trigger action="resume,pause">
      <VariableCommand expression="0" name="sidebar_X"/>
      <VariableCommand expression="0" name="sidebar_Y"/>
      <VariableCommand expression="0" name="unlock_screen"/>
      <Command target="ScreenContent.visibility" value="true"/>
      <Command target="ScreenUnlock.visibility" value="false"/>
      <AnimationCommand target="default_content_y" command="play" tags="ScreenCancel"/>
      <Command target="Global.visibility" value="true"/>
      <AnimationCommand target="unlock_screen_offset_y" command="play" tags="ScreenNormal"/>

    </Trigger>
  </ExternalCommands>
  <!-- Начнём с макета -->
  <Group h="#sh" w="#sw" layered="true">
    <!-- Обои во весь экран -->
    <Wallpaper/>

    <!-- Переменные Разблокировки -->
    <Var name="unlockPosition" type="number" expression="(#default_content_y/@unlock_height)*(-1)"/>
    <Var name="unlockProgress" type="number" expression="ifelse(#unlockPosition {= 1, ifelse(#unlockPosition } 0, 1-#unlockPosition, 1), 0)"/>
    <Var name="unlockProgressInverted" type="number" expression="ifelse(#unlockPosition {= 1, ifelse(#unlockPosition } 0, #unlockPosition, 0), 1)"/>
    <Var name="user_img" expression="ifelse(strContains(@unlock_user_image,'com.android.fileexplorer'),strReplaceAll(@unlock_user_image,'content://com.android.fileexplorer.myprovider/external_files/','file:///sdcard/'),strContains(@unlock_user_image,'com.miui.gallery'),strReplaceAll(@unlock_user_image,'content://com.miui.gallery.open/raw/%2Fstorage%2Femulated%2F0%2F','file:///sdcard/'),@unlock_user_image)" type="string" const="true"/>
    <!-- Переменные боковой панели -->
    <Var expression="156" name="panel_width" type="number"/>
    <Var expression="(#sw-#panel_width)" name="panel_x" type="number"/>

    <!-- Контент панель -->
    <Group x="0" y="#default_content_y" h="#sh" w="#sw" name="ScreenContent" alpha="255*#unlockProgress" visibility="1">
      <!-- Дата и время -->
      <Group x="60" y="#sh-350">
        <DateTime size="150" x="0" y="0" color="#ffffff" format="HH:mm" fontFamily="mitype-clock"/>
        <DateTime size="65" x="0" y="150" color="#ffffff" format="EEEE, dd MMMM" fontFamily="mitype-clock"/>
      </Group>
    </Group>
    <Group x="0" y="0" h="#sh" w="#sw" name="ScreenUnlock" alpha="255*#unlock_screen" visibility="1">
      <Rectangle align="center" alignV="center" h="#sh" w="#sw" x="#sw/2" y="#sh/2" fillColor="#000000" alpha="255*(#unlock_screen*0.5)"/>
      <Group y="#unlock_screen_offset_y">
        <Group x="#sw/2" y="#sh/2" align="center" alignV="center">
          <Group y="-300">
            <Image x="0" y="0" h="300" w="300" align="center" src="resources/icons/User.png"/>
            <Group align="center" layered="true" h="300" w="300">
              <Image h="300" w="300" srcExp="@user_img" srcType="Uri"/>
              <Image h="300" w="300" src="resources/icons/Mask.png" xfermode="dst_in"/>
            </Group>
            <Text x="0" y="350" align="center" color="#ffffff" size="50" textExp="@unlock_user_label" bold="true"/>
            <!-- Кнопка разблокировки -->
            <Group y="500">
              <Rectangle align="center" alignV="center" h="100" w="540" x="0" y="0" fillColor="#000000" alpha="255*0.25"/>
              <Text size="50" align="center" alignV="center" color="#ffffff" textExp="'Login'" />
              <Button align="center" alignV="center" h="100" w="540" x="0" y="0">
                <Pressed>
                  <Rectangle align="center" alignV="center" h="100" w="540" x="0" y="0" strokeColor="#ffffff" weight="4"/>
                  <VariableCommand name="btn_vis" expression="0"/>
                </Pressed>
                <Triggers>
                  <Trigger action="up" condition="abs(#touch_begin_y-#touch_y){50**abs(#touch_begin_x-#touch_x){50">
                    <ExternCommand command="unlock"/>
                    <AnimationCommand target="unlock_screen" command="play" tags="ScreenTransperencyOut"/>
                    <AnimationCommand target="unlock_screen_offset_y" command="play" tags="ScreenUp"/>
                  </Trigger>
                </Triggers>
              </Button>
            </Group>
          </Group>
        </Group>
      </Group>
    </Group>
    <!-- Боковая панель -->
    <Group x="#panel_x+(#panel_width*#unlockProgressInverted)" h="#sh" w="#panel_width">
      <!-- Блюр обоев -->
      <Group h="#sh" w="#panel_width" x="0" y="0" clip="true">
        <Wallpaper x="0-#panel_x-(#panel_width*#unlockProgressInverted)" blur="50"/>
        <!-- Затемнение -->
        <Rectangle fillColor="#000000" h="#sh" w="#panel_width" alpha="255*0.25"/>
      </Group>
      <!-- Переменные Приложений -->
      <!-- Ширина и Высота иконки -->
      <Var expression="96" name="app_w_h" type="number"/>
      <Var expression="30" name="app_margin" type="number"/>
      <!-- Переменные экранных приложений -->
      <Var name="sys_app0P" type="number" expression="0"/>
      <Var name="sys_app1P" type="number" expression="#sys_app0P - #app_w_h"/>
      <Var name="sys_app2P" type="number" expression="#sys_app1P - #app_w_h"/>
      <Var name="sys_app3P" type="number" expression="#sys_app2P - #app_w_h"/>
      <Var name="sys_app4P" type="number" expression="#sys_app3P - #app_w_h"/>
      <Var name="sys_app5P" type="number" expression="#sys_app4P - #app_w_h"/>
      <Var name="sys_app6P" type="number" expression="#sys_app5P - #app_w_h"/>
      <!-- Переменные пользовательских приложений -->
      <!-- Видимость -->
      <Var expression="strIsEmpty(@app1.package)" name="app1V" type="boolean"/>
      <Var expression="strIsEmpty(@app2.package)" name="app2V" type="boolean"/>
      <Var expression="strIsEmpty(@app3.package)" name="app3V" type="boolean"/>
      <Var expression="strIsEmpty(@app4.package)" name="app4V" type="boolean"/>
      <Var expression="strIsEmpty(@app5.package)" name="app5V" type="boolean"/>
      <Var expression="strIsEmpty(@app6.package)" name="app6V" type="boolean"/>
      <!-- Позиция -->
      <Var name="usr_apps" type="number" expression="#sys_app6P - #app_w_h"/>
      <Var name="usr_app1P" type="number" expression="ifelse(#app1V, #app_w_h + (#app_margin*1), 0)"/>
      <Var name="usr_app2P" type="number" expression="ifelse(#app2V, 0, #usr_app1P - (#app_w_h) - (#app_margin*1))"/>
      <Var name="usr_app3P" type="number" expression="ifelse(#app3V, 0, #usr_app2P - (#app_w_h) - (#app_margin*1))"/>
      <Var name="usr_app4P" type="number" expression="ifelse(#app4V, 0, #usr_app3P - (#app_w_h) - (#app_margin*1))"/>
      <Var name="usr_app5P" type="number" expression="ifelse(#app5V, 0, #usr_app4P - (#app_w_h) - (#app_margin*1))"/>
      <Var name="usr_app6P" type="number" expression="ifelse(#app6V, 0, #usr_app5P - (#app_w_h) - (#app_margin*1))"/>

      <Group x="30" y="#sh - (#app_margin * 3)">
        <Group x="#app_w_h/2">
          <!-- Windows -->
          <Group y="#sys_app0P - (#app_margin * 0)">
            <Image x="0" y="0" h="#app_w_h" w="#app_w_h" align="center" alignV="center" src="resources/apps/windows/Windows-light.png"/>
            <Button align="center" alignV="center" h="#app_w_h" w="#app_w_h" x="0" y="0">
              <Pressed>
                <Image x="0" y="0" h="#app_w_h" w="#app_w_h" alpha="255*0.5" align="center" alignV="center" src="resources/apps/windows/Windows-dark.png"/>
              </Pressed>
            </Button>
          </Group>

          <!-- User -->
          <Group y="#sys_app1P - (#app_margin * 1)">
            <Group align="center" alignV="center" layered="true" h="#app_w_h" w="#app_w_h">
              <Image h="#app_w_h" w="#app_w_h" src="resources/icons/User.png"/>
              <Image h="#app_w_h" w="#app_w_h" src="resources/icons/Mask.png" xfermode="dst_in"/>
            </Group>
            <Group align="center" alignV="center" layered="true" h="#app_w_h" w="#app_w_h">
              <Image h="#app_w_h" w="#app_w_h" srcExp="@user_img" srcType="Uri"/>
              <Image h="#app_w_h" w="#app_w_h" src="resources/icons/Mask.png" xfermode="dst_in"/>
            </Group>
          </Group>

          <!-- Settings -->
          <Group y="#sys_app2P - (#app_margin * 2)">
            <Image x="0" y="0" h="#app_w_h" w="#app_w_h" align="center" alignV="center" src="resources/apps/windows/Settings.png"/>
            <Button align="center" alignV="center" h="#app_w_h" w="#app_w_h" x="0" y="0">
              <Pressed>
                <Rectangle align="center" alignV="center" h="#app_w_h" w="#app_w_h" x="0" y="0" fillColor="#000000" alpha="255*0.5"/>
              </Pressed>
              <Triggers>
                <Trigger action="up" condition="abs(#touch_begin_y-#touch_y){50**abs(#touch_begin_x-#touch_x){50">
                  <IntentCommand action="android.intent.action.MAIN" class="miui.maml.MamlConfigSettings" package="com.android.thememanager">
                    <Extra expression="'lockstyle'" name="maml_code" type="string"/>
                  </IntentCommand>
                  <ExternCommand command="unlock"/>
                </Trigger>
              </Triggers>
            </Button>
          </Group>

          <!-- Weather -->
          <Group y="#sys_app3P - (#app_margin * 3)">
            <Image x="0" y="0" h="#app_w_h" w="#app_w_h" align="center" alignV="center" src="resources/apps/windows/Weather.png"/>
          </Group>

          <!-- Groove -->
          <Group y="#sys_app4P - (#app_margin * 4)">
            <Image x="0" y="0" h="#app_w_h" w="#app_w_h" align="center" alignV="center" src="resources/apps/windows/Groove.png"/>
          </Group>

          <!-- Calendar -->
          <Group y="#sys_app5P - (#app_margin * 5)">
            <Image x="0" y="0" h="#app_w_h" w="#app_w_h" align="center" alignV="center" src="resources/apps/windows/Calendar.png"/>
          </Group>

          <!-- Camera -->
          <Group y="#sys_app6P - (#app_margin * 6)">
            <Image x="0" y="0" h="#app_w_h" w="#app_w_h" align="center" alignV="center" src="resources/apps/windows/Camera-Icon.png"/>
          </Group>

          <!-- Пользовательские приложения -->
          <Group y="#usr_apps - (#app_margin*7)">
            <Group y="#usr_app1P">
              <Image x="0" y="0" h="#app_w_h" w="#app_w_h" srcParas="@app1.package, @app1.class" align="center" alignV="center" srcFormat="%s,%s" srcType="ApplicationIcon"/>
            </Group>
            <Group y="#usr_app2P">
              <Image x="0" y="0" h="#app_w_h" w="#app_w_h" srcParas="@app2.package, @app2.class" align="center" alignV="center" srcFormat="%s,%s" srcType="ApplicationIcon"/>
            </Group>
            <Group y="#usr_app3P">
              <Image x="0" y="0" h="#app_w_h" w="#app_w_h" srcParas="@app3.package, @app3.class" align="center" alignV="center" srcFormat="%s,%s" srcType="ApplicationIcon"/>
            </Group>
            <Group y="#usr_app4P">
              <Image x="0" y="0" h="#app_w_h" w="#app_w_h" srcParas="@app4.package, @app4.class" align="center" alignV="center" srcFormat="%s,%s" srcType="ApplicationIcon"/>
            </Group>
            <Group y="#usr_app5P">
              <Image x="0" y="0" h="#app_w_h" w="#app_w_h" srcParas="@app5.package, @app5.class" align="center" alignV="center" srcFormat="%s,%s" srcType="ApplicationIcon"/>
            </Group>
            <Group y="#usr_app6P">
              <Image x="0" y="0" h="#app_w_h" w="#app_w_h" srcParas="@app6.package, @app6.class" align="center" alignV="center" srcFormat="%s,%s" srcType="ApplicationIcon"/>
            </Group>
          </Group>
        </Group>
      </Group>
    </Group>
    <Var name="unlock_screen">
      <VariableAnimation tag="ScreenTransperencyIn" initPause="true" loop="false">
        <Item time="0" value="0" easeType="ExpoEaseIn"/>
        <Item time="300" value="1"/>
      </VariableAnimation>
      <VariableAnimation tag="ScreenTransperencyOut" initPause="true" loop="false">
        <Item time="0" value="1" easeType="ExpoEaseOut"/>
        <Item time="300" value="0"/>
      </VariableAnimation>
    </Var>
    <Var name="unlock_screen_offset_y">
      <VariableAnimation tag="ScreenUp" initPause="true" loop="false">
        <Item time="0" value="0" easeType="ExpoEaseOut"/>
        <Item time="300" value="-(#sh/4)"/>
      </VariableAnimation>
      <VariableAnimation tag="ScreenNormal" initPause="true" loop="false">
        <Item time="0" value="#sh" easeType="ExpoEaseOut"/>
        <Item time="300" value="0"/>
      </VariableAnimation>
      <VariableAnimation tag="ScreenDown" initPause="true" loop="false">
        <Item time="0" value="#sh" easeType="ExpoEaseOut"/>
        <Item time="300" value="0"/>
      </VariableAnimation>
    </Var>
    <Var name="default_content_y">
      <VariableAnimation tag="ScreenSpringing" initPause="true" loop="false">
        <Item time="0" value="#Tdfy" easeType="BounceEaseOut"/>
        <Item time="600" value="0"/>
      </VariableAnimation>
      <VariableAnimation tag="ScreenStartUnlock" initPause="true" loop="false">
        <Item time="0" value="#Tdfy"/>
      </VariableAnimation>
      <VariableAnimation tag="ScreenCancel" initPause="true" loop="false">
        <Item time="0" value="#Tdfy" easeType="ExpoEaseOut"/>
        <Item time="600" value="0"/>
      </VariableAnimation>
    </Var>
  </Group>
  <!-- Жест Разблокировки -->
  <!-- Максимальная высота -->
  <Var expression="300" type="number" name="S_unlock"/>
  <!-- Чувствительность отсчёта -->
  <Var expression="50" type="number" name="S_sensivity"/>
  <!-- Чувствительность отсчёта -->
  <Var expression="150" type="number" name="S_swipeSensivity"/>
  <!-- Динамическая частота кадров -->
  <FramerateController initPause="true" loop="false" name="Current_FPS_Anim">
    <ControlPoint frameRate="60" time="0"/>
    <ControlPoint frameRate="60" time="2000"/>
    <ControlPoint frameRate="30" time="2001"/>
  </FramerateController>
  <ExternalCommands>
    <Trigger action="init">
      <!-- Инициализация состояния разблокировщика -->
      <VariableCommand expression="0" name="unlockButtonSwitch"/>
    </Trigger>
    <Trigger action="resume,pause">
      <AnimationCommand target="default_content_y" command="play" tags="ScreenCancel" condition="#Tdfy { - @unlock_height"/>
    </Trigger>
  </ExternalCommands>
  <Group visibility="@dev_mode">
    <Var expression="150" name="dbgSize" type="number"/>
    <Var expression="#dbgSize/2" name="dbgSize2p" type="number"/>
    <Var expression="#dbgSize2p/2" name="dbgSize4p" type="number"/>
    <Group name="dbgPos" w="#dbgSize" alignV="center" align="center">
      <Rectangle x="#dbgSize2p" y="0" w="4" h="#dbgSize" align="center" fillColor="#ffffff" />
      <Rectangle x="#dbgSize2p" y="#dbgSize2p" w="#dbgSize" h="4" align="center" alignV="center" fillColor="#ffffff" />
      <Circle x="#dbgSize2p" y="#dbgSize2p" r="#dbgSize4p" align="center" alignV="center"fillColor="#ffffff" cap="round"/>
      <Group x="#dbgSize" y="#dbgSize">
        <Text y="0+(30*1)" size="30" color="#ffffff" textExp="'Touch dx: ' + #Tx" />
        <Text y="0+(30*2)" size="30" color="#ffffff" textExp="'Touch y: ' + #Ty" />
        <Text y="0+(30*3)" size="30" color="#ffffff" textExp="'Touch begin x: ' + #Tbx" />
        <Text y="0+(30*4)" size="30" color="#ffffff" textExp="'Touch begin y: ' + #Tby" />
        <Text y="0+(30*5)" size="30" color="#ffffff" textExp="'Latest x: ' + #Lx" />
        <Text y="0+(30*6)" size="30" color="#ffffff" textExp="'Latest t: ' + #Ly" />
        <Text y="0+(30*7)" size="30" color="#ffffff" textExp="'Touch distance from x: ' + #Tdfx" />
        <Text y="0+(30*8)" size="30" color="#ffffff" textExp="'Touch distance from y: ' + #Tdfy" />
        <Text y="0+(30*9)" size="30" color="#ffffff" textExp="'Unlock progress: ' + #unlockPosition" />
        <Text y="0+(30*10)" size="30" color="#ffffff" textExp="'Def content y: ' + #default_content_y" />
        <Text y="0+(30*11)" size="30" color="#ffffff" textExp="'Unlock Height: ' + @unlock_height" />
        <Text y="0+(30*12)" size="30" color="#ffffff" textExp="'Unlock progress: ' + #unlockProgress" />
        <Text y="0+(30*13)" size="30" color="#ffffff" textExp="': ' + #" />
        <Text y="0+(30*14)" size="30" color="#ffffff" textExp="': ' + #" />
        <Text y="0+(30*15)" size="30" color="#ffffff" textExp="': ' + #" />
        <Text y="0+(30*16)" size="30" color="#ffffff" textExp="': ' + #" />
        <Text y="0+(30*17)" size="30" color="#ffffff" textExp="': ' + #" />
        <Text y="0+(30*18)" size="30" color="#ffffff" textExp="': ' + #" />
        <Text y="0+(30*19)" size="30" color="#ffffff" textExp="': ' + #" />
        <Text y="0+(30*20)" size="30" color="#ffffff" textExp="': ' + #" />
      </Group>
      <PositionAnimation tag="StartMoveTo" initPause="true" loop="false">
        <Item y="#Ly-#dbgSize2p" x="#Lx" time="0" easeType="ExpoEaseOut"/>
        <Item y="#Ty-#dbgSize2p" x="#Tx" time="1000"/>
      </PositionAnimation>
      <PositionAnimation tag="moveTo">
        <Item y="#Ty-#dbgSize2p" x="#Tx"/>
      </PositionAnimation>
    </Group>
  </Group>
  <Button x="0" y="0" h="#sh" w="#panel_x" name="Global">
    <Triggers>
      <!-- Нажатие : касание -->
      <Trigger action="down">

        <MultiCommand>

          <VariableCommand expression="int(#touch_x)" name="Tx"/>
          <VariableCommand expression="int(#touch_y)" name="Ty"/>
          <VariableCommand expression="int(#touch_begin_x)" name="Tbx"/>
          <VariableCommand expression="int(#touch_begin_y)" name="Tby"/>

          <AnimationCommand target="dbgPos" command="play" tags="StartMoveTo" />
          <!-- <AnimationCommand target="default_content_y" command="play" tags="ScreenStartUnlock" condition="#Tdfy {= 0"/> -->

        </MultiCommand>

      </Trigger>
      <!-- Нажатие : движение -->
      <Trigger action="move">

        <MultiCommand>

          <VariableCommand expression="int(#touch_x)" name="Tx"/>
          <VariableCommand expression="int(#touch_y)" name="Ty"/>

          <VariableCommand expression="int(#touch_x-#touch_begin_x)" name="Tdfx"/>
          <VariableCommand expression="int(#touch_y-#touch_begin_y)" name="Tdfy"/>

          <AnimationCommand target="dbgPos" command="play" tags="moveTo" />
          <AnimationCommand target="default_content_y" command="play" tags="ScreenStartUnlock" condition="#Tdfy {= 0"/>
        </MultiCommand>

      </Trigger>
      <!-- Нажатие : отпускание/отмена -->
      <Trigger action="up,cancel">

        <MultiCommand>

          <VariableCommand expression="int(#touch_x)" name="Lx"/>
          <VariableCommand expression="int(#touch_y)" name="Ly"/>

          <MultiCommand condition="(#Tdfy }= - @unlock_height) ** (#Tdfy {= 0)">
            <AnimationCommand target="default_content_y" command="play" tags="ScreenSpringing"/>
          </MultiCommand>

          <MultiCommand condition="#Tdfy {= - @unlock_height">
            <Command target="ScreenContent.visibility" value="false"/>
            <Command target="ScreenUnlock.visibility" value="true"/>
            <Command target="Global.visibility" value="false"/>
            <AnimationCommand target="unlock_screen" command="play" tags="ScreenTransperencyIn"/>
            <AnimationCommand target="unlock_screen_offset_y" command="play" tags="ScreenDown"/>
          </MultiCommand>

          <VariableCommand expression="0" name="Tdfx"/>
          <VariableCommand expression="0" name="Tdfy"/>
          <!-- <AnimationCommand target="dbgPos" command="play" tags="EndMoveTo" /> -->
        </MultiCommand>

      </Trigger>
    </Triggers>
  </Button>
</Lockscreen>